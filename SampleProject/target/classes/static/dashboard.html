<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>NexusMeet</title>
    <link rel="stylesheet" href="./custom.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" integrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA==" crossorigin="anonymous" referrerpolicy="no-referrer" />
</head>
<body>
<nav>
    <h1 class="gather-hub">
        <img src="./images/logo.png" class="logo">
    </h1>
    <ul>
        <li><a id="userName">Welcome :</a></li>
        <li>Support</li>
    </ul>
</nav>
<div class="container">
    <div class="row">
        <div class="col-12 text-right" style="text-align: right;">
            <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#exampleModalLong">
                New Meeting
            </button>
        </div>
    </div>
    <div class="row mt-5" id="meetingsList">

    </div>
</div>
<!-- Modal -->
<div class="modal fade" id="exampleModalLong" tabindex="-1" role="dialog" aria-labelledby="exampleModalLongTitle" aria-hidden="true" data-backdrop="static">
    <div class="modal-dialog modal-lg" role="document">
        <div id="image-loader-add" class="image-loader" style="display: none;">
            <img src="./images/loader.gif" class="loader-img">
        </div>
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="exampleModalLongTitle">NexusMeet title</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">

                <div class="col-12" >
                    <form id="meetingForm">

                        <div class="form-group">
                            <label class="control-label">Title:</label>
                            <input class="form-control" type="text" name="title" id="title"/>
                        </div>
                        <div class="form-group">
                            <label class="control-label">Start Date:</label>
                            <input type="date" class="form-control" id="meeting_date" />
                        </div>

                        <div class="form-group">
                            <label class="control-label">Start Time:</label>
                            <input type="time" class="form-control" id="start_time" />
                        </div>
                        <div class="form-group">
                            <label class="control-label">End Time:</label>
                            <input type="time" class="form-control" id="end_time"/>
                        </div>

                        <div class="form-group">
                            <label class="control-label">Add Guests:</label>
                            <input type="text" class="form-control" id="emailInput" placeholder="Enter email and press Enter">
                            <div id="emailList"></div>
                        </div>
                        <div class="form-group">
                            <label class="control-label">Agenda:</label>
                            <textarea class="form-control" name="agenda" id="description"></textarea>
                        </div>
                        <div>
                            <button class="new-metting-button" type="button" id="meetingButton">Create</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>



<div class="modal fade" id="editMeetingModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLongTitle" aria-hidden="true" data-backdrop="static">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editMeetingModalTitle">NexusMeet title</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <div id="image-loader-edit" class="image-loader" style="display: none;">
                    <img src="./images/loader.gif" class="loader-img">
                </div>
                <div class="col-12" >
                    <form id="editMeetingForm">
                        <input type="hidden" id="edit_meeting_id">

                        <div class="form-group">
                            <label class="control-label">Title:</label>
                            <input class="form-control" type="text" name="title" id="edit_title"/>
                        </div>
                        <div class="form-group">
                            <label class="control-label">Start Date:</label>
                            <input type="date" class="form-control" id="edit_meeting_date" />
                        </div>

                        <div class="form-group">
                            <label class="control-label">Start Time:</label>
                            <input type="time" class="form-control" id="edit_start_time" />
                        </div>
                        <div class="form-group">
                            <label class="control-label">End Time:</label>
                            <input type="time" class="form-control" id="edit_end_time"/>
                        </div>

                        <div class="form-group">
                            <label class="control-label">Agenda:</label>
                            <textarea class="form-control" name="agenda" id="edit_description"></textarea>
                        </div>
                        <div>
                            <button class="new-metting-button" type="button" id="editMeetingButton">Create</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>


<div class="modal fade" id="meetingAttendeesModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLongTitle" aria-hidden="true" data-backdrop="static">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editMeetingAttendees">Modal title</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <div class="col-12 mb-2">
                    <input type="hidden" id="meeting_id_attendees">
                    <div class="form-group">
                        <label class="control-label">Attendees</label>
                        <input type="email" class="form-control" id="attendees_email">
                    </div>
                    <div class="text-center">
                        <button type="button" class="btn btn-sm btn-info" onclick="addAttendees();">Add</button>
                    </div>
                </div>
                <div class="col-12 mt-2" >
                    <table class="table table-bodered table-condensed table-info">
                        <thead>
                        <tr>
                            <th>SNo.</th>
                            <th>Email</th>
                            <th>Action</th>
                        </tr>
                        </thead>
                        <tbody id="meetingAttendeesData">

                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<script
        src="https://code.jquery.com/jquery-3.7.1.min.js"
        integrity="sha256-/JqT3SQfawRcv/BIHPThkBvs0OEvtFFmqPF/lYI/Cxo="
        crossorigin="anonymous"></script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-cookie/1.4.1/jquery.cookie.min.js" integrity="sha512-3j3VU6WC5rPQB4Ld1jnLV7Kd5xr+cq9avvhwqzbH/taCRNURoeEpoPBK9pDyeukwSxwRPJ8fDgvYXd6SkaZ2TA==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>

<script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.9.2/dist/umd/popper.min.js" integrity="sha384-IQsoLXl5PILFhosVNubq5LC7Qb9DXgDA9i+tQ8Zj3iwWAwPtgFTxbJ8NT4GN1R8p" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.min.js" integrity="sha384-cVKIPhGWiC2Al4u+LWgxfKTRIcfu0JTxR+EQDz/bgldoEyl4H0zUF0QKbrJ0EcQF" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@9"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/js/all.min.js" integrity="sha512-GWzVrcGlo0TxTRvz9ttioyYJ+Wwk9Ck0G81D+eO63BaqHaJ3YZX9wuqjwgfcV/MrB2PhaVX9DkYVhbFpStnqpQ==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>

<script>

    function hideLoader(){
        var loaderContainer=document.querySelector(".image-loader");
        var contentContainer=document.getElementById("content");
        loaderContainer.display="none";
    }

    function showLoader(){
        var loaderContainer=document.querySelector(".image-loader");
        var contentContainer=document.getElementById("content");
        loaderContainer.display="block";
    }


        function toastFire(type, message, position, background = "#fff") {
            const Toast = Swal.mixin({
                toast: true,
                position: position,
                showConfirmButton: false,
                timerProgressBar: false,
                background: background
            })

            Toast.fire({
                icon: type,
                title: message
            })
        }

        $(document).ready(function(){
            if(!$.cookie('jwt')){
                location.href="/signin.html";
            }
            getMeetings();
        });
        var member_attendees = [$.cookie('email')];
        $(document).on("click","#meetingButton",function(event){
            $("#image-loader-add").css("display","grid");
            event.preventDefault();
            var jwt = $.cookie('jwt');
            let room_id = "gather"+Math.random();
            console.log(room_id);
            let formData =  {
                'title':$("#title").val(),
                'meeting_date':$("#meeting_date").val(),
                'start_time':$("#start_time").val(),
                'end_time':$("#end_time").val(),
                'description':$("#description").val(),
                'room_id':room_id,
                "meeting_attendees":member_attendees,
                "id":50
            };
            $.ajax({
                url: "https://nexusmeet.gatherhub.in/add",
                data: JSON.stringify(formData),
                header:{
                    "Authorization":jwt,
                    "Content-Type":"application/json"
                },
                processData: false,
                contentType: "application/json",
                type: 'POST',
                dataType: "json",
                success: function (data) {
                    $("#image-loader-add").css("display","none");
                    getMeetings();
                    toastFire('success','Meeting Scheduled', 'top-right');


                   $('#exampleModalLong').toggle('hide');
                     $('body').removeClass('modal-open');
                    $('.modal-backdrop').remove();
                   console.log(data);
                }, error: function (data) {

                     $('#exampleModalLong').toggle('hide');
                     $('body').removeClass('modal-open');
                    $('.modal-backdrop').remove();
                     console.log(data);
                    $("#image-loader-add").css("display","none");
                    getMeetings();
                    toastFire('success','Meeting Scheduled', 'top-right');
                    console.log(data);
                }
            });
        });



      document.addEventListener("DOMContentLoaded", function() {
      const emailInput = document.getElementById("emailInput");
      const emailList = document.getElementById("emailList");

      emailInput.addEventListener("keyup", function(event) {
        if (event.key === "Enter") {
          const email = emailInput.value.trim();

          if (isValidEmail(email)) {
            addEmail(email);
            emailInput.value = '';
          } else {
            alert("Please enter a valid email address");
          }
        }
      });

      function isValidEmail(email) {
        // Simple email validation, you may want to enhance it
        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        return emailRegex.test(email);
      }

      function addEmail(email) {
        const emailTag = document.createElement("span");
        emailTag.setAttribute('class','attendees-capsule');
        emailTag.textContent = email;
        emailList.appendChild(emailTag);
        member_attendees.push(email);
        console.log(member_attendees);
      }
    });

        function getMeetings(){
            var email = $.cookie('email');
            var jwt = $.cookie('jwt');
            let formData =  {
                'email':email,
                'jwt':jwt
            };
            $.ajax({
                url: "https://nexusmeet.gatherhub.in/get-meet-by-email",
                data: JSON.stringify(formData),
                header:{
                    "Authorization":jwt,
                    "Content-Type":"application/json"
                },
                processData: false,
                contentType: "application/json",
                type: 'POST',
                dataType: "json",
                success: function (data) {
                    const currentDate = new Date();
                    const formattedDate = currentDate.toISOString().split('T')[0];

                    var html = '';
                    for(var i = 0;i<data.length;i++){
                        var meetDataArr = data[i];

                        var meetDate = new Date(meetDataArr['meeting_date']);
                        var meetDateFormatted = meetDate.toISOString().split('T')[0];

                        var dayOfWeek = meetDate.toLocaleDateString('en-US', { weekday: 'long' });
                        var monthOfWeek = meetDate.toLocaleDateString('en-US', { month: 'long' });
                        var day = meetDate.getDate();


                        html += '<div class="col-md-4 col-sm-6 col-12 calendar-box-outer">';
                                html += '<div class="row calendar-box-shadow">';
                                    html += '<div class="col col-4">';
                                        html += '<div class="calender">';
                                            html +='<div class="calender-details">';
                                               html +=' <div class="calender-item">';
                                                    html +='<p class="month">'+monthOfWeek+'</p>';
                                                html +='</div>';
                                                html +='<div class="day-date-container">';
                                                    html +='<h2 class="date">'+day+'</h2>';
                                                    html +='<hr>';
                                                    html +='<h2 class="day">'+dayOfWeek+'</h2>';
                                                html +='</div>';
                                            html +='</div>';
                                        html +='</div>';
                                    html +='</div>';
                                    html +='<div class="col col-8">';
                                            html +='<h1 class="event-name-heading">'+meetDataArr['title']+'</h1>';
                                            html +='<p class="event-details-para">Time: From '+meetDataArr['start_time']+' To '+meetDataArr['end_time']+'</span></p>';
                                            html +='<p class="event-details-para">Agenda: <span class="event-details-span">'+meetDataArr['description']+'</span></p>';
                                            if(meetDataArr['meetingStatus'] == "0"){
                                                if(meetDateFormatted >= formattedDate){
                                                    html += '<a href="/join-meet.html?roomID='+meetDataArr['room_id']+'" class="btn btn-info btn-sm">Join</a>';
                                                    html += ' <button type="button" class="btn btn-sm btn-danger" data-bs-toggle="modal" data-bs-target="#meetingAttendeesModal" onclick="getMeetingAttendees('+meetDataArr["id"]+')">+/- Attendees</button>';
                                                    html += ' <button type="button" class="btn btn-sm btn-warning" data-bs-toggle="modal" data-bs-target="#editMeetingModal" onclick="getMeetingDetails('+meetDataArr["id"]+')"><i class="fa fa-edit"></i></button>';
                                                    html += ' <button type="button" class="btn btn-sm btn-danger" onclick="deleteMeeting('+meetDataArr["id"]+')"><i class="fa fa-trash"></i></button>';
                                                }else{
                                                    html += '<span class="badge bg-success" style="width:100%;">Completed</span>';
                                                }
                                            }else{
                                                html += '<span class="badge bg-danger" style="width:100%;">Cancelled</span>';
                                            }
                                    html +='</div>';
                                html +='</div>';
                            html +='</div>';

                    }

                    $("#meetingsList").html(html);
                }, error: function (data) {
                    console.log(data);
                }
            });
        }


        //..................................
        function getMeetingDetails(meeting_id){
            var email = $.cookie('email');
            var jwt = $.cookie('jwt');
            let formData =  {
                'id':meeting_id,
            };
            $.ajax({
                url: "https://nexusmeet.gatherhub.in/get-meet-details",
                data: JSON.stringify(formData),
                header:{
                    "Authorization":jwt,
                    "Content-Type":"application/json"
                },
                processData: false,
                contentType: "application/json",
                type: 'POST',
                dataType: "json",
                success: function (data) {
                    console.log(data);
                    const detailsArr = data;
                    console.log(detailsArr);
                    $("#edit_title").val(detailsArr["title"]);
                    $("#edit_meeting_date").val(detailsArr["meeting_date"]);
                    $("#edit_start_time").val(detailsArr["start_time"]);
                    $("#edit_end_time").val(detailsArr["end_time"]);
                    $("#edit_description").val(detailsArr["description"]);
                    $("#edit_meeting_id").val(meeting_id);
                }, error: function(data){
                    console.log(data);
                }
            })
        }

        $(document).on("click","#editMeetingButton",function(event){
            event.preventDefault();
            var jwt = $.cookie('jwt');
            var meeting_id = $("#edit_meeting_id").val();
            let formData =  {
                'title':$("#edit_title").val(),
                'meeting_date':$("#edit_meeting_date").val(),
                'start_time':$("#edit_start_time").val(),
                'end_time':$("#edit_end_time").val(),
                'description':$("#edit_description").val(),
                'id':meeting_id,
            };
            $.ajax({
                url: "https://nexusmeet.gatherhub.in/update-meeting",
                data: JSON.stringify(formData),
                header:{
                    "Authorization":jwt,
                    "Content-Type":"application/json"
                },
                processData: false,
                contentType: "application/json",
                type: 'POST',
                dataType: "json",
                success: function (data) {
                    getMeetings();
                    toastFire('success','Meeting Scheduled', 'top-right');
                   console.log(data);
                }, error: function (data) {
                    getMeetings();
                    toastFire('success','Meeting Scheduled', 'top-right');
                    console.log(data);
                }
            });
        });

        function getMeetingAttendees(meeting_id)
        {
            var email = $.cookie('email');
            var jwt = $.cookie('jwt');
            let formData =  {
                'id':meeting_id,
            };
            $("#meeting_id_attendees").val(meeting_id);
            $.ajax({
                url: "https://nexusmeet.gatherhub.in/get-meet-attendees",
                data: JSON.stringify(formData),
                header:{
                    "Authorization":jwt,
                    "Content-Type":"application/json"
                },
                processData: false,
                contentType: "application/json",
                type: 'POST',
                dataType: "json",
                success: function (data) {
                    console.log(data);
                    const detailsArr = data;

                    var html = "";
                    for(var i = 0;i<data.length;i++){
                        var meetDataArr = data[i];
                        html += '<tr>';
                            html += '<td>'+ i+1 +'</td>';
                            html += '<td>'+ meetDataArr['email'] +'</td>';
                            html += '<td><button type="button" class="btn btn-sm btn-danger" onclick="removeAttendees('+meetDataArr['id']+', '+meeting_id+')">Remove</button></td>';
                        html += '</tr>';
                    }

                    $("#meetingAttendeesData").html(html);

                }, error: function(data){
                    console.log(data);
                }
            })
        }

        function removeAttendees(id, meeting_id)
        {
            var email = $.cookie('email');
            var jwt = $.cookie('jwt');
            let formData =  {
                'id':id,
            };
            $.ajax({
                url: "https://nexusmeet.gatherhub.in/remove-attendees",
                data: JSON.stringify(formData),
                header:{
                    "Authorization":jwt,
                    "Content-Type":"application/json"
                },
                processData: false,
                contentType: "application/json",
                type: 'POST',
                dataType: "json",
                success: function (data) {
                    console.log(data);
                    getMeetingAttendees(meeting_id);
                    toastFire('success','Attendees Removed Scheduled', 'top-right');
                }, error: function(data){
                    console.log(data);
                }
            })
        }

        function addAttendees()
        {
            var email = $.cookie('email');
            var jwt = $.cookie('jwt');
            var attendees_email = $("#attendees_email").val();
            var meeting_id = $("#meeting_id_attendees").val();
            let formData =  {
                'email':attendees_email,
                'meeting_id':meeting_id
            };
            $.ajax({
                url: "https://nexusmeet.gatherhub.in/add-attendees",
                data: JSON.stringify(formData),
                header:{
                    "Authorization":jwt,
                    "Content-Type":"application/json"
                },
                processData: false,
                contentType: "application/json",
                type: 'POST',
                dataType: "json",
                success: function (data) {
                    console.log(data);
                    getMeetingAttendees(meeting_id);
                    toastFire('success','Attendees Removed Scheduled', 'top-right');
                }, error: function(data){
                    console.log(data);
                }
            })
        }






        function deleteMeeting(meeting_id){
            event.preventDefault();
            var jwt = $.cookie('jwt');
            var meeting_status = 2;
            const formData={
                "id":meeting_id,
                "meeting_status":meeting_status
            }

            $.ajax({
                url: "https://nexusmeet.gatherhub.in/cancel",
                data: JSON.stringify(formData),
                header:{
                    "Authorization":jwt,
                    "Content-Type":"application/json"
                },
                processData: false,
                contentType: "application/json",
                type: 'POST',
                dataType: "json",
                success: function (data) {
                    getMeetings();
                    toastFire('success','Meeting Cancelled', 'top-right');
                   console.log(data);
                }, error: function (data) {
                    getMeetings();
                    toastFire('success','Meeting Cancelled', 'top-right');
                    console.log(data);
                }
            });
        }
</script>

</body>
</html>